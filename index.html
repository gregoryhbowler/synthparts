<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memorymoog Ladder Filter</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #1a1a1a;
      --bg-panel: #252525;
      --bg-control: #2d2d2d;
      --accent: #d4a574;
      --accent-dim: #8a6a4a;
      --text: #e0e0e0;
      --text-dim: #888;
      --led-on: #ff6b4a;
      --led-off: #4a2a2a;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 300;
      letter-spacing: 4px;
      text-transform: uppercase;
      color: var(--accent);
      margin: 0 0 5px 0;
    }
    
    .subtitle {
      font-size: 0.75rem;
      color: var(--text-dim);
      letter-spacing: 2px;
      margin-bottom: 30px;
    }
    
    .synth-panel {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 30px;
      box-shadow: 
        0 10px 40px rgba(0,0,0,0.5),
        inset 0 1px 0 rgba(255,255,255,0.05);
      max-width: 800px;
      width: 100%;
    }
    
    .controls-section {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .control-label {
      font-size: 0.65rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 10px;
    }
    
    .knob-container {
      position: relative;
      width: 80px;
      height: 80px;
    }
    
    .knob {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(145deg, #3a3a3a, #1f1f1f);
      box-shadow: 
        0 4px 15px rgba(0,0,0,0.4),
        inset 0 2px 3px rgba(255,255,255,0.05);
      cursor: pointer;
      position: relative;
    }
    
    .knob::after {
      content: '';
      position: absolute;
      width: 4px;
      height: 20px;
      background: var(--accent);
      border-radius: 2px;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      transform-origin: center 32px;
    }
    
    .knob-value {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.8rem;
      color: var(--accent);
      font-variant-numeric: tabular-nums;
    }
    
    .oscillator-section {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 20px;
      background: var(--bg-control);
      border-radius: 8px;
      margin-bottom: 25px;
    }
    
    .osc-control {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .waveform-select {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .wave-btn {
      width: 36px;
      height: 28px;
      background: var(--bg-dark);
      border: 1px solid var(--accent-dim);
      border-radius: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    
    .wave-btn:hover {
      border-color: var(--accent);
    }
    
    .wave-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent);
    }
    
    .wave-btn svg {
      width: 20px;
      height: 14px;
      stroke: var(--text);
      fill: none;
      stroke-width: 1.5;
    }
    
    .small-knob-container {
      width: 50px;
      height: 50px;
    }
    
    .small-knob {
      width: 50px;
      height: 50px;
    }
    
    .small-knob::after {
      width: 3px;
      height: 12px;
      top: 6px;
      transform-origin: center 19px;
    }
    
    .play-section {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    
    .play-btn {
      padding: 12px 40px;
      font-size: 0.8rem;
      letter-spacing: 2px;
      text-transform: uppercase;
      background: transparent;
      border: 1px solid var(--accent-dim);
      color: var(--text);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .play-btn:hover {
      border-color: var(--accent);
      background: rgba(212, 165, 116, 0.1);
    }
    
    .play-btn.active {
      background: var(--accent);
      color: var(--bg-dark);
      border-color: var(--accent);
    }
    
    .status-led {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--led-off);
      display: inline-block;
      margin-right: 8px;
      transition: all 0.15s;
    }
    
    .status-led.on {
      background: var(--led-on);
      box-shadow: 0 0 10px var(--led-on);
    }
    
    .keyboard {
      display: flex;
      justify-content: center;
      gap: 2px;
      padding: 15px;
      background: var(--bg-control);
      border-radius: 8px;
    }
    
    .key {
      width: 40px;
      height: 120px;
      background: linear-gradient(180deg, #f5f5f5 0%, #d0d0d0 100%);
      border: 1px solid #999;
      border-radius: 0 0 4px 4px;
      cursor: pointer;
      position: relative;
      transition: all 0.05s;
    }
    
    .key:hover {
      background: linear-gradient(180deg, #fff 0%, #e0e0e0 100%);
    }
    
    .key:active, .key.active {
      background: linear-gradient(180deg, #e0e0e0 0%, #c0c0c0 100%);
      transform: translateY(2px);
    }
    
    .key.black {
      width: 28px;
      height: 75px;
      background: linear-gradient(180deg, #3a3a3a 0%, #1a1a1a 100%);
      border-color: #000;
      margin: 0 -14px;
      z-index: 1;
    }
    
    .key.black:hover {
      background: linear-gradient(180deg, #4a4a4a 0%, #2a2a2a 100%);
    }
    
    .key.black:active, .key.black.active {
      background: linear-gradient(180deg, #2a2a2a 0%, #0a0a0a 100%);
    }
    
    .analyzer-container {
      display: flex;
      gap: 20px;
      margin-top: 25px;
    }
    
    .analyzer {
      flex: 1;
      height: 100px;
      background: var(--bg-control);
      border-radius: 8px;
      overflow: hidden;
    }
    
    .analyzer canvas {
      width: 100%;
      height: 100%;
    }
    
    .info-text {
      text-align: center;
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 20px;
    }
    
    @media (max-width: 700px) {
      .controls-section {
        grid-template-columns: repeat(2, 1fr);
      }
      .oscillator-section {
        grid-template-columns: repeat(2, 1fr);
      }
      .key {
        width: 30px;
        height: 90px;
      }
      .key.black {
        width: 22px;
        height: 55px;
        margin: 0 -11px;
      }
    }
  </style>
</head>
<body>
  <h1>Memorymoog</h1>
  <div class="subtitle">24dB Ladder Filter</div>
  
  <div class="synth-panel">
    <!-- Main Filter Controls -->
    <div class="controls-section">
      <div class="control-group">
        <div class="control-label">Cutoff</div>
        <div class="knob-container">
          <div class="knob" id="cutoffKnob" data-param="cutoff" data-min="20" data-max="20000" data-value="2000" data-exp="true"></div>
          <div class="knob-value" id="cutoffValue">2000 Hz</div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-label">Resonance</div>
        <div class="knob-container">
          <div class="knob" id="resonanceKnob" data-param="resonance" data-min="0" data-max="1" data-value="0.3"></div>
          <div class="knob-value" id="resonanceValue">30%</div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-label">Drive</div>
        <div class="knob-container">
          <div class="knob" id="driveKnob" data-param="drive" data-min="0" data-max="1" data-value="0.2"></div>
          <div class="knob-value" id="driveValue">20%</div>
        </div>
      </div>
      
      <div class="control-group">
        <div class="control-label">Warmth</div>
        <div class="knob-container">
          <div class="knob" id="warmthKnob" data-param="warmth" data-min="0" data-max="1" data-value="1"></div>
          <div class="knob-value" id="warmthValue">100%</div>
        </div>
      </div>
    </div>
    
    <!-- Oscillator Controls -->
    <div class="oscillator-section">
      <div class="osc-control">
        <div class="control-label">Waveform</div>
        <div class="waveform-select">
          <button class="wave-btn active" data-wave="sawtooth" title="Sawtooth">
            <svg viewBox="0 0 20 14"><path d="M2 12 L10 2 L10 12 L18 2"/></svg>
          </button>
          <button class="wave-btn" data-wave="square" title="Square">
            <svg viewBox="0 0 20 14"><path d="M2 10 L2 4 L10 4 L10 10 L18 10 L18 4"/></svg>
          </button>
          <button class="wave-btn" data-wave="triangle" title="Triangle">
            <svg viewBox="0 0 20 14"><path d="M2 10 L6 2 L14 12 L18 4"/></svg>
          </button>
          <button class="wave-btn" data-wave="sine" title="Sine">
            <svg viewBox="0 0 20 14"><path d="M2 7 Q6 0 10 7 Q14 14 18 7"/></svg>
          </button>
        </div>
      </div>
      
      <div class="osc-control">
        <div class="control-label">Octave</div>
        <div class="knob-container small-knob-container">
          <div class="knob small-knob" id="octaveKnob" data-param="octave" data-min="-2" data-max="2" data-value="0" data-step="1"></div>
          <div class="knob-value" id="octaveValue">0</div>
        </div>
      </div>
      
      <div class="osc-control">
        <div class="control-label">Detune</div>
        <div class="knob-container small-knob-container">
          <div class="knob small-knob" id="detuneKnob" data-param="detune" data-min="-50" data-max="50" data-value="0"></div>
          <div class="knob-value" id="detuneValue">0 ct</div>
        </div>
      </div>
      
      <div class="osc-control">
        <div class="control-label">Volume</div>
        <div class="knob-container small-knob-container">
          <div class="knob small-knob" id="volumeKnob" data-param="volume" data-min="0" data-max="1" data-value="0.5"></div>
          <div class="knob-value" id="volumeValue">50%</div>
        </div>
      </div>
    </div>
    
    <!-- Play Controls -->
    <div class="play-section">
      <button class="play-btn" id="startBtn">
        <span class="status-led" id="statusLed"></span>
        Start Audio
      </button>
      <button class="play-btn" id="droneBtn">Drone A3</button>
    </div>
    
    <!-- Keyboard -->
    <div class="keyboard" id="keyboard">
      <div class="key" data-note="C3"></div>
      <div class="key black" data-note="C#3"></div>
      <div class="key" data-note="D3"></div>
      <div class="key black" data-note="D#3"></div>
      <div class="key" data-note="E3"></div>
      <div class="key" data-note="F3"></div>
      <div class="key black" data-note="F#3"></div>
      <div class="key" data-note="G3"></div>
      <div class="key black" data-note="G#3"></div>
      <div class="key" data-note="A3"></div>
      <div class="key black" data-note="A#3"></div>
      <div class="key" data-note="B3"></div>
      <div class="key" data-note="C4"></div>
      <div class="key black" data-note="C#4"></div>
      <div class="key" data-note="D4"></div>
      <div class="key black" data-note="D#4"></div>
      <div class="key" data-note="E4"></div>
    </div>
    
    <!-- Analyzers -->
    <div class="analyzer-container">
      <div class="analyzer">
        <canvas id="waveformCanvas"></canvas>
      </div>
      <div class="analyzer">
        <canvas id="spectrumCanvas"></canvas>
      </div>
    </div>
    
    <div class="info-text">
      Click keys or use keyboard (A-K for white keys, W-U for black keys) â€¢ Scroll on knobs to adjust
    </div>
  </div>

  <script>
    // ==================== Audio Engine ====================
    class MoogSynth {
      constructor() {
        this.audioContext = null;
        this.moogFilter = null;
        this.oscillator = null;
        this.gainNode = null;
        this.analyser = null;
        this.isRunning = false;
        this.currentNote = null;
        this.waveform = 'sawtooth';
        this.octaveShift = 0;
        this.detune = 0;
        this.volume = 0.5;
        
        // Note frequencies
        this.noteFreqs = {
          'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56,
          'E3': 164.81, 'F3': 174.61, 'F#3': 185.00, 'G3': 196.00,
          'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
          'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13,
          'E4': 329.63
        };
        
        // Keyboard mapping
        this.keyMap = {
          'a': 'C3', 'w': 'C#3', 's': 'D3', 'e': 'D#3', 'd': 'E3',
          'f': 'F3', 't': 'F#3', 'g': 'G3', 'y': 'G#3', 'h': 'A3',
          'u': 'A#3', 'j': 'B3', 'k': 'C4', 'o': 'C#4', 'l': 'D4',
          'p': 'D#4', ';': 'E4'
        };
      }
      
      async init() {
        if (this.audioContext) return;
        
        this.audioContext = new AudioContext();
        
        // Load the Moog processor
        await this.audioContext.audioWorklet.addModule('moog-processor.js');
        
        // Create nodes
        this.moogFilter = new AudioWorkletNode(this.audioContext, 'moog-ladder-processor');
        this.gainNode = this.audioContext.createGain();
        this.analyser = this.audioContext.createAnalyser();
        
        // Configure analyser
        this.analyser.fftSize = 2048;
        this.analyser.smoothingTimeConstant = 0.8;
        
        // Connect: filter -> gain -> analyser -> output
        this.moogFilter.connect(this.gainNode);
        this.gainNode.connect(this.analyser);
        this.analyser.connect(this.audioContext.destination);
        
        // Set initial gain
        this.gainNode.gain.value = this.volume;
        
        this.isRunning = true;
        document.getElementById('statusLed').classList.add('on');
        document.getElementById('startBtn').classList.add('active');
        document.getElementById('startBtn').innerHTML = 
          '<span class="status-led on"></span>Audio Running';
        
        // Start visualization
        this.startVisualization();
      }
      
      setParameter(name, value) {
        if (!this.moogFilter) return;
        
        const param = this.moogFilter.parameters.get(name);
        if (param) {
          param.setValueAtTime(value, this.audioContext.currentTime);
        }
      }
      
      playNote(note) {
        if (!this.audioContext || !this.isRunning) return;
        
        const freq = this.noteFreqs[note];
        if (!freq) return;
        
        // Apply octave shift
        const shiftedFreq = freq * Math.pow(2, this.octaveShift);
        
        // Stop previous note
        this.stopNote();
        
        // Create oscillator
        this.oscillator = this.audioContext.createOscillator();
        this.oscillator.type = this.waveform;
        this.oscillator.frequency.value = shiftedFreq;
        this.oscillator.detune.value = this.detune;
        
        // Simple envelope
        const envelope = this.audioContext.createGain();
        envelope.gain.setValueAtTime(0, this.audioContext.currentTime);
        envelope.gain.linearRampToValueAtTime(1, this.audioContext.currentTime + 0.01);
        
        this.oscillator.connect(envelope);
        envelope.connect(this.moogFilter);
        
        this.oscillator.start();
        this.currentNote = { oscillator: this.oscillator, envelope };
      }
      
      stopNote() {
        if (this.currentNote) {
          const { oscillator, envelope } = this.currentNote;
          const now = this.audioContext.currentTime;
          
          envelope.gain.cancelScheduledValues(now);
          envelope.gain.setValueAtTime(envelope.gain.value, now);
          envelope.gain.linearRampToValueAtTime(0, now + 0.1);
          
          oscillator.stop(now + 0.15);
          this.currentNote = null;
        }
      }
      
      setWaveform(type) {
        this.waveform = type;
        if (this.oscillator) {
          this.oscillator.type = type;
        }
      }
      
      setOctave(shift) {
        this.octaveShift = shift;
      }
      
      setDetune(cents) {
        this.detune = cents;
        if (this.oscillator) {
          this.oscillator.detune.value = cents;
        }
      }
      
      setVolume(vol) {
        this.volume = vol;
        if (this.gainNode) {
          this.gainNode.gain.value = vol;
        }
      }
      
      startVisualization() {
        const waveCanvas = document.getElementById('waveformCanvas');
        const specCanvas = document.getElementById('spectrumCanvas');
        const waveCtx = waveCanvas.getContext('2d');
        const specCtx = specCanvas.getContext('2d');
        
        // Set canvas resolution
        const dpr = window.devicePixelRatio || 1;
        waveCanvas.width = waveCanvas.offsetWidth * dpr;
        waveCanvas.height = waveCanvas.offsetHeight * dpr;
        specCanvas.width = specCanvas.offsetWidth * dpr;
        specCanvas.height = specCanvas.offsetHeight * dpr;
        
        const waveData = new Uint8Array(this.analyser.frequencyBinCount);
        const specData = new Uint8Array(this.analyser.frequencyBinCount);
        
        const draw = () => {
          requestAnimationFrame(draw);
          
          // Waveform
          this.analyser.getByteTimeDomainData(waveData);
          waveCtx.fillStyle = '#2d2d2d';
          waveCtx.fillRect(0, 0, waveCanvas.width, waveCanvas.height);
          waveCtx.lineWidth = 2 * dpr;
          waveCtx.strokeStyle = '#d4a574';
          waveCtx.beginPath();
          
          const sliceWidth = waveCanvas.width / waveData.length;
          let x = 0;
          for (let i = 0; i < waveData.length; i++) {
            const v = waveData[i] / 128.0;
            const y = v * waveCanvas.height / 2;
            if (i === 0) waveCtx.moveTo(x, y);
            else waveCtx.lineTo(x, y);
            x += sliceWidth;
          }
          waveCtx.stroke();
          
          // Spectrum
          this.analyser.getByteFrequencyData(specData);
          specCtx.fillStyle = '#2d2d2d';
          specCtx.fillRect(0, 0, specCanvas.width, specCanvas.height);
          
          const barWidth = specCanvas.width / 64;
          x = 0;
          for (let i = 0; i < 64; i++) {
            const barHeight = (specData[i] / 255) * specCanvas.height;
            specCtx.fillStyle = `hsl(30, 50%, ${30 + specData[i] / 5}%)`;
            specCtx.fillRect(x, specCanvas.height - barHeight, barWidth - 1, barHeight);
            x += barWidth;
          }
        };
        
        draw();
      }
    }
    
    // ==================== Knob Control ====================
    class KnobControl {
      constructor(element, onChange) {
        this.element = element;
        this.onChange = onChange;
        this.min = parseFloat(element.dataset.min);
        this.max = parseFloat(element.dataset.max);
        this.value = parseFloat(element.dataset.value);
        this.step = parseFloat(element.dataset.step) || null;
        this.isExp = element.dataset.exp === 'true';
        
        this.isDragging = false;
        this.startY = 0;
        this.startValue = 0;
        
        this.updateVisual();
        this.bindEvents();
      }
      
      bindEvents() {
        this.element.addEventListener('mousedown', this.onMouseDown.bind(this));
        this.element.addEventListener('wheel', this.onWheel.bind(this), { passive: false });
        document.addEventListener('mousemove', this.onMouseMove.bind(this));
        document.addEventListener('mouseup', this.onMouseUp.bind(this));
      }
      
      onMouseDown(e) {
        this.isDragging = true;
        this.startY = e.clientY;
        this.startValue = this.value;
        e.preventDefault();
      }
      
      onMouseMove(e) {
        if (!this.isDragging) return;
        
        const delta = (this.startY - e.clientY) / 150;
        let newValue;
        
        if (this.isExp) {
          // Exponential scaling for frequency
          const logMin = Math.log(this.min);
          const logMax = Math.log(this.max);
          const logStart = Math.log(this.startValue);
          const logValue = logStart + delta * (logMax - logMin);
          newValue = Math.exp(logValue);
        } else {
          newValue = this.startValue + delta * (this.max - this.min);
        }
        
        this.setValue(newValue);
      }
      
      onMouseUp() {
        this.isDragging = false;
      }
      
      onWheel(e) {
        e.preventDefault();
        const delta = -e.deltaY / 1000;
        let newValue;
        
        if (this.isExp) {
          const logMin = Math.log(this.min);
          const logMax = Math.log(this.max);
          const logCurrent = Math.log(this.value);
          const logValue = logCurrent + delta * (logMax - logMin);
          newValue = Math.exp(logValue);
        } else {
          newValue = this.value + delta * (this.max - this.min);
        }
        
        this.setValue(newValue);
      }
      
      setValue(val) {
        // Apply step if defined
        if (this.step) {
          val = Math.round(val / this.step) * this.step;
        }
        
        this.value = Math.max(this.min, Math.min(this.max, val));
        this.updateVisual();
        this.onChange(this.value);
      }
      
      updateVisual() {
        // Calculate rotation (-135 to 135 degrees)
        let normalized;
        if (this.isExp) {
          const logMin = Math.log(this.min);
          const logMax = Math.log(this.max);
          const logVal = Math.log(this.value);
          normalized = (logVal - logMin) / (logMax - logMin);
        } else {
          normalized = (this.value - this.min) / (this.max - this.min);
        }
        
        const rotation = -135 + normalized * 270;
        this.element.style.setProperty('--rotation', `${rotation}deg`);
        this.element.querySelector('::after') || 
          (this.element.style.cssText += `--rotation: ${rotation}deg`);
        
        // Update the indicator
        const indicator = this.element.querySelector('::after');
        this.element.style.transform = ''; // Reset
        const style = document.createElement('style');
        style.textContent = `#${this.element.id}::after { transform: translateX(-50%) rotate(${rotation}deg); }`;
        
        // Remove old dynamic style if exists
        const oldStyle = document.getElementById(`style-${this.element.id}`);
        if (oldStyle) oldStyle.remove();
        
        style.id = `style-${this.element.id}`;
        document.head.appendChild(style);
      }
    }
    
    // ==================== Initialize ====================
    const synth = new MoogSynth();
    const knobs = {};
    
    // Initialize knobs
    document.querySelectorAll('.knob').forEach(el => {
      const param = el.dataset.param;
      
      knobs[param] = new KnobControl(el, (value) => {
        // Update display
        const displayEl = document.getElementById(`${param}Value`);
        if (displayEl) {
          switch(param) {
            case 'cutoff':
              displayEl.textContent = value < 1000 
                ? `${Math.round(value)} Hz` 
                : `${(value/1000).toFixed(1)} kHz`;
              synth.setParameter('cutoff', value);
              break;
            case 'resonance':
              displayEl.textContent = `${Math.round(value * 100)}%`;
              synth.setParameter('resonance', value);
              break;
            case 'drive':
              displayEl.textContent = `${Math.round(value * 100)}%`;
              synth.setParameter('drive', value);
              break;
            case 'warmth':
              displayEl.textContent = `${Math.round(value * 100)}%`;
              synth.setParameter('warmth', value);
              break;
            case 'octave':
              displayEl.textContent = value > 0 ? `+${value}` : `${value}`;
              synth.setOctave(value);
              break;
            case 'detune':
              displayEl.textContent = `${Math.round(value)} ct`;
              synth.setDetune(value);
              break;
            case 'volume':
              displayEl.textContent = `${Math.round(value * 100)}%`;
              synth.setVolume(value);
              break;
          }
        }
      });
    });
    
    // Waveform buttons
    document.querySelectorAll('.wave-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.wave-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        synth.setWaveform(btn.dataset.wave);
      });
    });
    
    // Start button
    document.getElementById('startBtn').addEventListener('click', async () => {
      await synth.init();
    });
    
    // Drone button
    let isDroning = false;
    document.getElementById('droneBtn').addEventListener('click', async () => {
      if (!synth.isRunning) await synth.init();
      
      if (isDroning) {
        synth.stopNote();
        isDroning = false;
        document.getElementById('droneBtn').classList.remove('active');
      } else {
        synth.playNote('A3');
        isDroning = true;
        document.getElementById('droneBtn').classList.add('active');
      }
    });
    
    // Keyboard
    document.querySelectorAll('.key').forEach(key => {
      key.addEventListener('mousedown', async (e) => {
        if (!synth.isRunning) await synth.init();
        synth.playNote(key.dataset.note);
        key.classList.add('active');
      });
      
      key.addEventListener('mouseup', () => {
        if (!isDroning) synth.stopNote();
        key.classList.remove('active');
      });
      
      key.addEventListener('mouseleave', () => {
        if (!isDroning) synth.stopNote();
        key.classList.remove('active');
      });
    });
    
    // Computer keyboard support
    const activeKeys = new Set();
    
    document.addEventListener('keydown', async (e) => {
      if (activeKeys.has(e.key.toLowerCase())) return;
      
      const note = synth.keyMap[e.key.toLowerCase()];
      if (note) {
        if (!synth.isRunning) await synth.init();
        activeKeys.add(e.key.toLowerCase());
        synth.playNote(note);
        
        const keyEl = document.querySelector(`[data-note="${note}"]`);
        if (keyEl) keyEl.classList.add('active');
      }
    });
    
    document.addEventListener('keyup', (e) => {
      const note = synth.keyMap[e.key.toLowerCase()];
      if (note) {
        activeKeys.delete(e.key.toLowerCase());
        if (!isDroning && activeKeys.size === 0) synth.stopNote();
        
        const keyEl = document.querySelector(`[data-note="${note}"]`);
        if (keyEl) keyEl.classList.remove('active');
      }
    });
  </script>
</body>
</html>
